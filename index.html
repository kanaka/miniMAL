<!--
Copyright (c) 2024 Joel Martin
Copyright (c) 2012 Fogus, Jen Myers and Relevance Inc.
All rights reserved. The use and distribution terms for this software
are covered by the Eclipse Public License 1.0
(http://opensource.org/licenses/eclipse-1.0.php) which can be found in
the file COPYING the root of this distribution.  By using this
software in any fashion, you are agreeing to be bound by the terms of
this license.  You must not remove this notice, or any other, from
this software.
-->

<html>
<head>
  <link rel="stylesheet" type="text/css" href="js/web/base.css" />
  <link rel="stylesheet" type="text/css" href="js/web/layout.css" />
  <link rel="stylesheet" type="text/css" href="js/web/skeleton.css" />
  <link rel="stylesheet" type="text/css" href="js/web/himera.css" />
  <link rel="stylesheet" type="text/css" href="js/web/ansi.css" />
  <link rel="stylesheet" type="text/css" href="js/web/console.css" />
  <style type="text/css" media="screen">
  </style>
  <title>miniMAL Web REPL</title>
</head>
<body>
  <div class="container">
    <h1 id="title"><a href="https://github.com/kanaka/miniMAL"/>miniMAL</a></h1>

    <h2>A Delightfully Diminutive Lisp</h2>

    <div id="console-container" class="sixteen columns">
    <div class="console" id="console"></div>
    </div>
    <div class="eleven columns" style="font-family: monospace">
      miniMAL: &nbsp;<a href="js/web/miniMAL-min.js">min</a> (&nbsp;824 bytes),
       <a href="js/stepB_web.js">orig</a> (4053 bytes, 119 lines)<br>
      Core Lib: <a href="js/web/miniMAL-core.js">min</a> (1086 bytes),
       <a href="js/core.json">orig</a> (4161 bytes, 120 lines)
    </div>
    <div class="five columns">
      <div class="source">
        <a href="http://github.com/kanaka/miniMAL">View source on Github <img src="js/web/github-icon.png" /></a></p>
      </div><!-- /source -->
    </div>

    <div class="rule sixteen columns"></div>

    <div class="sixteen columns">
      <h3>miniMAL at a glance</h3>
    </div>

    <div class="cheat-box-container eight columns">
      <div class="cheat-box">
        <h4>Lisp-0 / JSON Source</h4>
        <table>
          <tr class="row-one">
            <td class="row-label">Scalars</td>
            <td>123, null, true, false, "symbol", "+"</td>
          </tr>
          <tr>
            <td class="row-label">Strings</td>
            <td>["`", "quoted symbol is a string"]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">List</td>
            <td>[7, 8, 9]</td>
          </tr>
          <tr>
            <td class="row-label">Objects</td>
            <td>{"a": 123, "b": 789}</td>
          </tr>
        </table>
      </div><!-- /cheat-box -->
      <div class="cheat-box">
        <h4>Functions</h4>
        <table>
          <tr class="row-one">
            <td class="row-label">Calling</td>
            <td>["+", 2, 3]</td>
          </tr>
          <tr>
            <td class="row-label">Anonymous</td>
            <td>["fn", ["a"], ["+", 2, "a"]]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Named</td>
            <td>["def", "inc2",<br>
                &nbsp;&nbsp;["fn", ["a"], ["+", 2, "a"]]]</td>
          </tr>
          <tr>
            <td class="row-label">Higher Order</td>
            <td>["map", "inc2",<br>
                &nbsp;&nbsp;["list", 2,3,4]]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Variadic</td>
            <td>["def", "drop1",<br>
                &nbsp;&nbsp;["fn", ["a", "&amp;", "b"], "b"]]</td>
          </tr>
        </table>
      </div><!-- /cheat-box -->
      <div class="cheat-box">
        <h4>Core Library</h4>
        <table>
          <tr class="row-one">
            <td class="row-label">Math</td>
            <td>"+", "-", "*", "/"</td>
          </tr>
          <tr>
            <td class="row-label">Conditional Macros</td>
            <td>"and", "or"</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Comparison/Boolean</td>
            <td>"=", "&lt;", "&gt;", "&lt;=", "&gt;=", "not"</td>
          </tr>
          <tr>
            <td class="row-label">Predicates</td>
            <td>"null?", "true?", "false?", "string?", "list?",
                "contains?", "empty?"</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">List Functions</td>
            <td>"map", "apply", "list", "cons", "concat", "nth",
                "first", "last", "rest", "count", "empty?"</td>
          </tr>
          <tr>
            <td class="row-label">Object Functions</td>
            <td>"get", "set", "contains?", "keys", "vals"</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">String Functions</td>
            <td>"str", "pr-str", "prn", "println"</td>
          </tr>
          <tr>
            <td class="row-label">Other</td>
            <td>"throw"</td>
          </tr>
        </table>
      </div><!-- /cheat-box -->
    </div><!-- /cheat-box-container -->

    <div class="cheat-box-container eight columns">
      <div class="cheat-box">
        <h4>Special Forms</h4>
        <table>
          <tr class="row-one">
            <td class="row-label">Conditional</td>
            <td>["if", ["&gt;", 3, 2], 7, 8]</td>
          </tr>
          <tr>
            <td class="row-label">Multiple Actions<br>(side-effects)</td>
            <td>["do", ["prn", 123], 456]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Environment Bindings</td>
            <td>["def", "x", 123]<br>
                ["let", ["y", 456],<br>
                &nbsp;&nbsp;["*", 2, "y"]]</td>
          </tr>
          <tr>
            <td class="row-label">Quote</td>
            <td>["`", ["prn", 123]]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Error Handling</td>
            <td>["try", "abc",<br>
                &nbsp;&nbsp;["catch", "e",<br>
                &nbsp;&nbsp;&nbsp;&nbsp;["prn", "e"]]]</td>
          </tr>
        </table>
      </div><!-- /cheat-box -->
      <div class="cheat-box">
        <h4>Metaprogramming</h4>
        <table>
          <tr class="row-one">
            <td class="row-label">Macros</td>
            <td>["def","unless",["~",["fn",["p","a","b"],<br>
                &nbsp;&nbsp;["list",["`","if"],"p","b","a"]]]]</td>
          </tr>
          <tr>
            <td class="row-label">Read</td>
            <td>["read",["`", "[\"+\", 2,3]"]]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Eval</td>
            <td>["eval",["`", ["+", 2,3]]]</td>
          </tr>
        </table>
      </div><!-- /cheat-box -->
      <div class="cheat-box">
        <h4>JavaScript Interop</h4>
        <table>
          <tr class="row-one">
            <td class="row-label">Evaluate JavaScript</td>
            <td>["js", ["`", "2 + 3"]]</td>
          </tr>
          <tr>
            <td class="row-label">Method call</td>
            <td>[".", "Object",<br>
                &nbsp;&nbsp;["`", "keys"], {"a": 1}]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Get attribute</td>
            <td>[".-", "Math", ["`", "PI"]]</td>
          </tr>
          <tr>
            <td class="row-label">Set attribute</td>
            <td>[".-", "window",<br>
                &nbsp;&nbsp;["`", "location"],<br>
                &nbsp;&nbsp;["`", "http://github.com"]]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Delete attribute</td>
            <td>["del", "window",<br>
                &nbsp;&nbsp;["`", "console"],<br>
          </tr>
          <tr>
            <td class="row-label">Object Class</td>
            <td>["classOf", 123]</td>
          </tr>
          <tr class="row-one">
            <td class="row-label">Inheritance Test</td>
            <td>["isa", {}, "Object"]</td>
          </tr>
          <tr>
            <td class="row-label">Instantiate Object</td>
            <td>["new", "Array", 3]</td>
          </tr>
        </table>
      </div><!-- /cheat-box -->
    </div><!-- /cheat-box-container -->

    <div class="rule sixteen columns"></div>

    <div class="column footer-logo">
        <div>miniMAL &copy; 2022 Joel Martin</div>
        <div>Himera design &copy; 2012-2013 <a ref="http://www.fogus.me">Fogus</a>, <a href="http://jenmyers.net/">Jen Myers</a> and <a href="http://www.thinkrelevance.com">Relevance Inc.</a></div>
    </div>

  </div><!-- / container -->
  <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript" src="js/web/jqconsole.min.js"></script>
  <script type="text/javascript" src="js/web/miniMAL-min.js"></script>
  <script type="text/javascript" src="js/web/miniMAL-core.js"></script>
  <script>
    $(function() {
      //
      // Setup jqconsole
      //
      window.jqconsole = $('#console').jqconsole(null, '> ')
      var max_history_length = 1000

      function jq_load_history(jq) {
          if (localStorage['miniMAL_history']) {
              var lines = JSON.parse(localStorage['miniMAL_history'])
              if (lines.length > max_history_length) {
                  lines = lines.slice(lines.length-max_history_length)
              }
              jq.SetHistory(lines)
          }
      }

      function jq_save_history(jq) {
          var lines = jq.GetHistory()
          localStorage['miniMAL_history'] = JSON.stringify(lines)
      }


      jq_load_history(jqconsole)

      // Abort prompt on Ctrl+C.
      jqconsole.RegisterShortcut('C', function() {
        jqconsole.AbortPrompt()
        handler()
      })
      // Move to line start Ctrl+A.
      jqconsole.RegisterShortcut('A', function() {
        jqconsole.MoveToStart()
        handler()
      })
      // Move to line end Ctrl+E.
      jqconsole.RegisterShortcut('E', function() {
        jqconsole.MoveToEnd()
        handler()
      })
      jqconsole.RegisterMatching('{', '}', 'brace')
      jqconsole.RegisterMatching('[', ']', 'bracket')
      jqconsole.RegisterMatching('"', '"', 'dquote')

      //
      // Setup miniMAL
      //
      var m = miniMAL(window)

      // Load in the core library
      m.eval(core_ns)
      //m.eval(["load", ["`", "js/core.json"]])


      // Add file loading and printing functions to the core library
      var slurp = function(f) {
        var req = new XMLHttpRequest()
        req.open("GET", f, false)
        req.send()
        if (req.status == 200) {
          return req.responseText
        } else {
          throw new Error("Failed to slurp file: " + f)
        }
      }

      jqprintln = function (...a) {
        jqconsole.Write(a.join(" ") + "\n", 'jqconsole-output')
        return null
      }

      Object.assign(m, {
        "slurp":   slurp,
        "load":    f => m.eval(JSON.parse(m.slurp(f))),
        "prn":     (...s) => jqprintln(s.map(JSON.stringify).join(" ")),
        "println": (...s) => jqprintln(s.map(x => typeof x === 'string' ? x : JSON.stringify(x)).join(" ")),
      })

      // Print out the banner
      m.eval(["println", ["`", "miniMAL 1.2.0"]])


      //
      // Main REPL handler/callback
      //
      var handler = function(line) {
        if (line) {
          try {
            jqconsole.Write(m.rep(line) + '\n', 'jqconsole-return')
          } catch (exc) {
            if (exc.stack) {
              jqconsole.Write(exc.stack + '\n', 'jqconsole-error')
            } else {
              jqconsole.Write(exc + '\n', 'jqconsole-error')
            }
          }
          jq_save_history(jqconsole)
        }
        jqconsole.Prompt(true, handler)
      }

      // Initiate the first prompt.
      handler()
    })
  </script>

</body>
</html>
